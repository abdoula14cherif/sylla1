<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SYLLA ‚Äî Mon Profil</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@300;400;500;600;700&family=Outfit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --purple:#A064FF;--purple-l:#C084FC;--purple-d:#7C3AED;
  --teal:#00C9C0;--teal-l:#00EDDE;
  --orange:#FF7A35;--gold:#F5C842;--red:#FF3B4E;--green:#00D166;
  --bg:#080610;--bg2:#0E0B1A;
  --text:#F5F0FF;--text2:#9B85C4;--text3:#4A3878;
  --nav-h:70px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:calc(var(--nav-h)+24px);}
.bg-mesh{position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 60% 50% at 70% 0%,rgba(160,100,255,.14) 0%,transparent 60%),radial-gradient(ellipse 50% 55% at 5% 80%,rgba(0,201,192,.08) 0%,transparent 55%),linear-gradient(160deg,#080610 0%,#0E0B1A 55%,#0A0914 100%);}
.bg-grid{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(160,100,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(160,100,255,.04) 1px,transparent 1px);background-size:50px 50px;}

/* LOADING */
.loading-screen{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .5s,visibility .5s;}
.loading-screen.hide{opacity:0;visibility:hidden;pointer-events:none;}
.load-logo{font-family:'Bebas Neue',cursive;font-size:52px;letter-spacing:8px;background:linear-gradient(135deg,var(--purple),var(--teal-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:pulse 1.5s ease-in-out infinite;}
.load-bar{width:120px;height:2px;background:rgba(160,100,255,.15);border-radius:2px;overflow:hidden;}
.load-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--teal));border-radius:2px;animation:lf 1.5s ease-in-out infinite;}
@keyframes lf{0%{width:0%;margin-left:0}50%{width:100%;margin-left:0}100%{width:0%;margin-left:100%}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}

.page{position:relative;z-index:2;padding:0 16px 20px;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 12px;position:sticky;top:0;z-index:50;background:rgba(8,6,16,.93);backdrop-filter:blur(20px);border-bottom:1px solid rgba(160,100,255,.12);margin:0 -16px 0;}
.back-btn{display:flex;align-items:center;gap:8px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--purple-l);text-decoration:none;padding:8px 14px;border:1px solid rgba(160,100,255,.3);border-radius:20px;transition:all .2s;}
.page-title-top{font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:4px;background:linear-gradient(135deg,var(--purple-l),var(--teal-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logout-btn{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--red);padding:8px 14px;border:1px solid rgba(255,59,78,.25);border-radius:20px;background:transparent;cursor:pointer;}

/* HERO */
.profile-hero{text-align:center;padding:28px 16px 24px;animation:fadeUp .6s ease both;}
.avatar-wrap{position:relative;width:90px;height:90px;margin:0 auto 14px;}
.avatar-big{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--purple-d),var(--purple),var(--purple-l));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:36px;letter-spacing:2px;color:#fff;box-shadow:0 0 0 3px rgba(160,100,255,.25),0 0 30px rgba(160,100,255,.2);}
.avatar-ring{position:absolute;inset:-6px;border-radius:50%;border:2px solid transparent;background:linear-gradient(135deg,var(--purple),var(--teal),var(--orange)) border-box;-webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);-webkit-mask-composite:destination-out;mask-composite:exclude;animation:spin 4s linear infinite;}
.profile-name{font-family:'Bebas Neue',cursive;font-size:30px;letter-spacing:3px;background:linear-gradient(135deg,#fff,var(--purple-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.profile-email{font-size:13px;font-weight:300;color:var(--text2);margin-top:4px;}
.profile-since{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-top:6px;}
.vip-badge{display:inline-flex;align-items:center;gap:8px;border-radius:100px;padding:8px 20px;margin-top:12px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:rgba(255,255,255,.04);border-radius:18px;overflow:hidden;border:1px solid rgba(160,100,255,.12);margin:20px 0;animation:fadeUp .6s .1s ease both;}
.sr-item{background:rgba(0,0,0,.3);padding:16px 8px;text-align:center;}
.sr-val{font-family:'Bebas Neue',cursive;font-size:26px;letter-spacing:1px;line-height:1;}
.sr-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-top:4px;}

/* REFERRAL */
.ref-card{background:linear-gradient(135deg,rgba(245,200,66,.08),rgba(160,100,255,.05));border:1px solid rgba(245,200,66,.25);border-radius:18px;padding:18px;margin-bottom:14px;animation:fadeUp .6s .15s ease both;}
.ref-top{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.ref-ico{width:42px;height:42px;border-radius:12px;background:rgba(245,200,66,.1);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.ref-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--text);}
.ref-sub{font-size:12px;font-weight:300;color:var(--text3);margin-top:2px;}
.ref-code-box{background:rgba(0,0,0,.3);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid rgba(245,200,66,.15);}
.ref-code-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(245,200,66,.6);margin-bottom:6px;}
.ref-code-val{font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:6px;color:var(--gold);}
.ref-link-val{font-size:11px;font-weight:300;color:var(--text2);margin-top:6px;word-break:break-all;line-height:1.4;}
.ref-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.ref-btn{padding:11px;border-radius:10px;border:none;cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;transition:all .2s;}
.rb-copy{background:rgba(245,200,66,.1);color:var(--gold);border:1px solid rgba(245,200,66,.25);}
.rb-share{background:linear-gradient(135deg,var(--purple-d),var(--purple));color:#fff;}

/* HOW IT WORKS */
.how-section{background:rgba(255,255,255,.03);border:1px solid rgba(160,100,255,.1);border-radius:18px;padding:16px;margin-bottom:14px;animation:fadeUp .6s .2s ease both;}
.how-title{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--purple-l);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.how-steps{display:flex;flex-direction:column;gap:10px;}
.how-step{display:flex;align-items:flex-start;gap:12px;padding:12px;background:rgba(0,0,0,.2);border-radius:12px;border:1px solid rgba(160,100,255,.08);}
.hs-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',cursive;font-size:14px;color:#fff;flex-shrink:0;}
.hs-body{}
.hs-title{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:.5px;color:var(--text);}
.hs-desc{font-size:12px;font-weight:300;color:var(--text3);margin-top:2px;line-height:1.5;}
.gain-badges{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
.gb{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:10px;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;border:1px solid;}

/* REF STATS */
.ref-stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px;}
.rs-item{background:rgba(0,0,0,.3);border-radius:12px;padding:12px 8px;text-align:center;border:1px solid rgba(255,255,255,.05);}
.rs-val{font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:1px;}
.rs-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-top:3px;}

/* SECTIONS */
.sec-block{background:rgba(255,255,255,.03);border:1px solid rgba(160,100,255,.1);border-radius:20px;overflow:hidden;margin-bottom:14px;animation:fadeUp .6s .25s ease both;}
.sec-header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid rgba(160,100,255,.08);cursor:pointer;user-select:none;}
.sec-ico{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.sec-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--text);flex:1;}
.sec-arrow{color:var(--text3);font-size:14px;transition:transform .25s;}
.sec-block.open .sec-arrow{transform:rotate(90deg);}
.sec-body{display:none;padding:18px;}
.sec-block.open .sec-body{display:block;}

/* FORM */
.field-grp{margin-bottom:14px;}
.field-lbl{display:block;font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--purple-l);margin-bottom:7px;opacity:.8;}
.field-inp{width:100%;background:rgba(160,100,255,.05);border:1.5px solid rgba(160,100,255,.18);border-radius:10px;padding:12px 15px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:300;color:var(--text);outline:none;transition:all .25s;}
.field-inp::placeholder{color:rgba(155,133,196,.3);font-size:13px;}
.field-inp:focus{border-color:var(--purple-l);background:rgba(160,100,255,.09);box-shadow:0 0 0 4px rgba(160,100,255,.1);}
.field-inp:read-only{opacity:.55;cursor:default;}
.save-btn{width:100%;padding:14px;border:none;border-radius:12px;cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#fff;background:linear-gradient(135deg,var(--purple-d),var(--purple));box-shadow:0 8px 24px rgba(160,100,255,.28);transition:all .3s;margin-top:4px;}
.save-btn:hover{transform:translateY(-2px);}
.save-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
.ld{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px;}

/* HISTORY */
.hist-mini{display:flex;flex-direction:column;gap:8px;}
.hm-item{display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(0,0,0,.2);border-radius:12px;border:1px solid rgba(255,255,255,.04);}
.hm-ico{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.hm-info{flex:1;min-width:0;}
.hm-type{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hm-date{font-size:10px;font-weight:300;color:var(--text3);margin-top:1px;}
.hm-amount{font-family:'Bebas Neue',cursive;font-size:17px;letter-spacing:1px;flex-shrink:0;}

/* ALERTS */
.al{display:none;align-items:center;gap:10px;padding:11px 14px;border-radius:10px;font-size:13px;margin-bottom:14px;}
.al.show{display:flex;}
.al-ok{background:rgba(0,209,102,.1);border:1px solid rgba(0,209,102,.3);color:#4ADE80;}
.al-err{background:rgba(255,59,78,.08);border:1px solid rgba(255,59,78,.25);color:#FF6B7A;}

/* TOAST */
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(0,209,102,.9);backdrop-filter:blur(12px);color:#fff;padding:10px 22px;border-radius:100px;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:1.5px;z-index:500;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.err{background:rgba(255,59,78,.9);}

/* BOT NAV */
.bot-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;height:var(--nav-h);background:rgba(8,6,16,.94);backdrop-filter:blur(24px);border-top:1px solid rgba(160,100,255,.12);display:grid;grid-template-columns:repeat(4,1fr);box-shadow:0 -8px 32px rgba(0,0,0,.5);}
.nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;text-decoration:none;transition:all .2s;padding:8px 4px;position:relative;}
.nav-item::before{content:'';position:absolute;top:0;left:20%;right:20%;height:2px;border-radius:0 0 4px 4px;background:linear-gradient(90deg,var(--purple),var(--teal-l));transform:scaleX(0);transition:transform .3s;}
.nav-item.active::before{transform:scaleX(1);}
.nav-item.active .nav-ico,.nav-item.active .nav-lbl{color:var(--purple-l);}
.nav-ico{font-size:20px;color:var(--text3);}
.nav-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);}
</style>
</head>
<body>

<div class="loading-screen" id="loader">
  <div class="load-logo">PROFIL</div>
  <div class="load-bar"><div class="load-fill"></div></div>
</div>

<div class="bg-mesh"></div><div class="bg-grid"></div>
<div class="toast" id="toast"></div>

<div class="page">
  <div class="topbar">
    <a href="dashboard.html" class="back-btn">‚Üê Accueil</a>
    <div class="page-title-top">MON PROFIL</div>
    <button class="logout-btn" onclick="logout()">D√©connexion</button>
  </div>

  <!-- HERO -->
  <div class="profile-hero">
    <div class="avatar-wrap">
      <div class="avatar-big" id="avatar-big">S</div>
      <div class="avatar-ring"></div>
    </div>
    <div class="profile-name" id="profile-name">Chargement‚Ä¶</div>
    <div class="profile-email" id="profile-email">‚Äî</div>
    <div class="profile-since" id="profile-since">Membre depuis ‚Äî</div>
    <div class="vip-badge" id="vip-badge" style="background:rgba(205,127,50,.1);border:1px solid rgba(205,127,50,.3);color:#CD7F32;">ü•â Membre Bronze</div>
  </div>

  <!-- STATS -->
  <div class="stats-row">
    <div class="sr-item"><div class="sr-val" style="color:var(--teal)" id="stat-balance">0</div><div class="sr-lbl">Solde (F)</div></div>
    <div class="sr-item"><div class="sr-val" style="color:var(--gold)" id="stat-refs">0</div><div class="sr-lbl">Filleuls</div></div>
    <div class="sr-item"><div class="sr-val" style="color:var(--purple-l)" id="stat-plans">0</div><div class="sr-lbl">Plans actifs</div></div>
  </div>

  <!-- REFERRAL CARD -->
  <div class="ref-card">
    <div class="ref-top">
      <div class="ref-ico">üéÅ</div>
      <div>
        <div class="ref-title">Parrainage SYLLA</div>
        <div class="ref-sub">Gagnez 10% sur chaque investissement de vos filleuls</div>
      </div>
    </div>
    <div class="ref-code-box">
      <div class="ref-code-lbl">üè∑ Votre code unique</div>
      <div class="ref-code-val" id="ref-code">SYLLA-‚Äî‚Äî</div>
      <div class="ref-link-val" id="ref-link">Chargement‚Ä¶</div>
    </div>
    <div class="ref-btns">
      <button class="ref-btn rb-copy" onclick="copyCode()">üìã Copier code</button>
      <button class="ref-btn rb-share" onclick="shareRef()">üîó Partager lien</button>
    </div>
    <div class="ref-stats-row">
      <div class="rs-item"><div class="rs-val" style="color:var(--gold)" id="ref-n1">0</div><div class="rs-lbl">Filleuls Niv.1</div></div>
      <div class="rs-item"><div class="rs-val" style="color:var(--orange)" id="ref-n2">0</div><div class="rs-lbl">Filleuls Niv.2</div></div>
      <div class="rs-item"><div class="rs-val" style="color:var(--green)" id="ref-earn">0F</div><div class="rs-lbl">Gains parr.</div></div>
    </div>
  </div>

  <!-- HOW IT WORKS -->
  <div class="how-section">
    <div class="how-title">üí° Comment fonctionne le parrainage</div>
    <div class="how-steps">
      <div class="how-step">
        <div class="hs-num" style="background:linear-gradient(135deg,var(--purple-d),var(--purple))">1</div>
        <div class="hs-body"><div class="hs-title">Partagez votre lien</div><div class="hs-desc">Envoyez votre lien unique √† vos amis, famille, ou sur les r√©seaux sociaux.</div></div>
      </div>
      <div class="how-step">
        <div class="hs-num" style="background:linear-gradient(135deg,var(--teal-d,#009E97),var(--teal))">2</div>
        <div class="hs-body"><div class="hs-title">Votre filleul s'inscrit</div><div class="hs-desc">Il re√ßoit automatiquement <strong style="color:var(--gold)">+1 000 FCFA</strong> de bonus de bienvenue. Vous gagnez <strong style="color:var(--green)">+500 FCFA</strong> imm√©diatement.</div></div>
      </div>
      <div class="how-step">
        <div class="hs-num" style="background:linear-gradient(135deg,#B8960C,var(--gold))">3</div>
        <div class="hs-body"><div class="hs-title">Il investit ‚Üí Vous gagnez</div><div class="hs-desc">√Ä chaque investissement de votre filleul, vous recevez <strong style="color:var(--gold)">10% du montant</strong> automatiquement sur votre solde.</div></div>
      </div>
      <div class="how-step">
        <div class="hs-num" style="background:linear-gradient(135deg,#CC5A10,var(--orange))">4</div>
        <div class="hs-body"><div class="hs-title">Niveau 2 ‚Äî Encore plus</div><div class="hs-desc">Quand votre filleul parraine lui-m√™me quelqu'un, vous gagnez <strong style="color:var(--orange)">5% suppl√©mentaires</strong> sur les investissements de ce niveau 2.</div></div>
      </div>
    </div>
    <div class="gain-badges">
      <div class="gb" style="background:rgba(245,200,66,.1);border-color:rgba(245,200,66,.3);color:var(--gold)">ü•á Niveau 1 ¬∑ +10% / investissement</div>
      <div class="gb" style="background:rgba(255,122,53,.1);border-color:rgba(255,122,53,.3);color:var(--orange)">ü•à Niveau 2 ¬∑ +5% / investissement</div>
      <div class="gb" style="background:rgba(0,209,102,.1);border-color:rgba(0,209,102,.3);color:var(--green)">üéÅ Inscription filleul ¬∑ +500 FCFA</div>
    </div>
  </div>

  <!-- EDIT PROFILE -->
  <div class="sec-block open">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(160,100,255,.12)">üë§</div>
      <div class="sec-title">Modifier le profil</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="al al-ok" id="edit-ok"><span>‚úì</span> Profil mis √† jour !</div>
      <div class="al al-err" id="edit-err"><span>‚úï</span><span id="edit-emsg">Erreur.</span></div>
      <form id="form-edit">
        <div class="field-grp"><label class="field-lbl">Nom complet</label><input class="field-inp" type="text" id="edit-nom" placeholder="Votre nom complet"></div>
        <div class="field-grp"><label class="field-lbl">T√©l√©phone</label><input class="field-inp" type="tel" id="edit-tel" placeholder="+225 07 00 00 00"></div>
        <div class="field-grp"><label class="field-lbl">Email (lecture seule)</label><input class="field-inp" type="email" id="edit-email" readonly></div>
        <button class="save-btn" type="submit" id="edit-btn">üíæ Sauvegarder</button>
      </form>
    </div>
  </div>

  <!-- HISTORY -->
  <div class="sec-block">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(0,201,192,.1)">üìã</div>
      <div class="sec-title">Historique des transactions</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="hist-mini" id="hist-mini">
        <div style="text-align:center;padding:16px;color:var(--text3);font-size:13px">Chargement‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD -->
  <div class="sec-block">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(255,122,53,.1)">üîê</div>
      <div class="sec-title">Changer le mot de passe</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="al al-ok" id="pwd-ok"><span>‚úì</span> Mot de passe mis √† jour !</div>
      <div class="al al-err" id="pwd-err"><span>‚úï</span><span id="pwd-emsg">Erreur.</span></div>
      <form id="form-pwd">
        <div class="field-grp"><label class="field-lbl">Nouveau mot de passe</label><input class="field-inp" type="password" id="new-pwd" placeholder="Minimum 8 caract√®res" minlength="8"></div>
        <div class="field-grp"><label class="field-lbl">Confirmer</label><input class="field-inp" type="password" id="conf-pwd" placeholder="R√©p√©tez le mot de passe"></div>
        <button class="save-btn" type="submit" id="pwd-btn" style="background:linear-gradient(135deg,#CC5A10,var(--orange))">üîí Mettre √† jour</button>
      </form>
    </div>
  </div>

</div>

<nav class="bot-nav">
  <a href="dashboard.html" class="nav-item"><span class="nav-ico">üè†</span><span class="nav-lbl">Accueil</span></a>
  <a href="plan.html" class="nav-item"><span class="nav-ico">üöÄ</span><span class="nav-lbl">Plans</span></a>
  <a href="retrait.html" class="nav-item"><span class="nav-ico">üí∏</span><span class="nav-lbl">Retrait</span></a>
  <a href="profil.html" class="nav-item active"><span class="nav-ico">üë§</span><span class="nav-lbl">Profil</span></a>
</nav>

<script>
const{createClient}=supabase;
const sb=createClient('https://fqiotqrraobmsrcyewsi.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxaW90cXJyYW9ibXNyY3lld3NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjA3NzUsImV4cCI6MjA4NzM5Njc3NX0.pmvaQikEDEj705o7kBBWwkLwAoZ62D-GoxjFm5HEHNc');

let cu=null;
const VIP=[
  {min:0,label:'ü•â Membre Bronze',bg:'rgba(205,127,50,.1)',border:'rgba(205,127,50,.3)',color:'#CD7F32'},
  {min:10000,label:'ü•à Membre Argent',bg:'rgba(192,192,192,.1)',border:'rgba(192,192,192,.3)',color:'#C0C0C0'},
  {min:50000,label:'ü•á Membre Or',bg:'rgba(245,200,66,.1)',border:'rgba(245,200,66,.3)',color:'#F5C842'},
  {min:150000,label:'üíé Membre Diamant',bg:'rgba(160,100,255,.15)',border:'rgba(160,100,255,.4)',color:'#A064FF'},
];

async function init(){
  try{
    const{data:{session},error:se}=await sb.auth.getSession();
    if(se||!session){window.location.href='index.html';return;}
    cu=session.user;
    // Run all in parallel ‚Äî don't let one failure block everything
    await Promise.allSettled([loadProfile(),loadStats(),loadHistory()]);
    buildRefCode();
  }catch(e){
    console.error('Init error:',e);
    // Still hide loader even on error
  }finally{
    document.getElementById('loader').classList.add('hide');
  }
}

async function loadProfile(){
  let name=cu.user_metadata?.full_name||cu.user_metadata?.name||'';
  let phone=cu.user_metadata?.phone||'';
  // Try to get from profiles table ‚Äî graceful fallback if table missing
  try{
    const{data,error}=await sb.from('profiles').select('*').eq('id',cu.id).single();
    if(!error&&data){name=data.full_name||name;phone=data.phone||phone;}
  }catch(e){/* table may not exist yet, use metadata */}

  const initial=(name[0]||cu.email[0]||'S').toUpperCase();
  document.getElementById('avatar-big').textContent=initial;
  document.getElementById('profile-name').textContent=name||'Investisseur SYLLA';
  document.getElementById('profile-email').textContent=cu.email||'‚Äî';
  const created=new Date(cu.created_at||Date.now());
  document.getElementById('profile-since').textContent='Membre depuis le '+created.toLocaleDateString('fr-FR',{day:'2-digit',month:'long',year:'numeric'});
  document.getElementById('edit-nom').value=name;
  document.getElementById('edit-tel').value=phone;
  document.getElementById('edit-email').value=cu.email||'';
}

async function loadStats(){
  let total=0,plans=0,refEarned=0,refN1=0;
  try{
    const[soldeRes,invRes,refRes]=await Promise.allSettled([
      sb.rpc('get_solde',{p_user_id:cu.id}),  // Solde r√©el via function SQL
      sb.from('investments').select('id').eq('user_id',cu.id).eq('status','active'),
      sb.from('transactions').select('amount').eq('user_id',cu.id).eq('type','commission'),
    ]);
    if(soldeRes.status==='fulfilled')total=Math.max(0,Number(soldeRes.value.data)||0);
    if(invRes.status==='fulfilled')plans=invRes.value.data?.length||0;
    if(refRes.status==='fulfilled'&&refRes.value.data){
      refEarned=refRes.value.data.reduce((s,t)=>s+Number(t.amount),0);
      refN1=refRes.value.data.length;
    }
    // Also count referrals from referrals table
    const{data:refs}=await sb.from('referrals').select('id,niveau').eq('referrer_id',cu.id);
    if(refs)refN1=refs.filter(r=>r.niveau===1).length;
  }catch(e){}
  document.getElementById('stat-balance').textContent=fmtShort(total);
  document.getElementById('stat-plans').textContent=plans;
  document.getElementById('stat-refs').textContent=refN1;
  document.getElementById('ref-n1').textContent=refN1;
  document.getElementById('ref-n2').textContent=0;
  document.getElementById('ref-earn').textContent=fmtShort(refEarned)+'F';
  const vip=VIP.reduce((v,l)=>total>=l.min?l:v,VIP[0]);
  const badge=document.getElementById('vip-badge');
  badge.textContent=vip.label;
  badge.style.background=vip.bg;badge.style.border='1px solid '+vip.border;badge.style.color=vip.color;
}

async function loadHistory(){
  const typeMap={
    bonus_bienvenue:{ico:'üéÅ',bg:'rgba(245,200,66,.1)',col:'#F5C842'},
    depot:{ico:'üí∞',bg:'rgba(74,222,128,.08)',col:'#4ADE80'},
    investissement:{ico:'üìà',bg:'rgba(0,201,192,.08)',col:'#00C9C0'},
    gain:{ico:'‚ú®',bg:'rgba(74,222,128,.08)',col:'#4ADE80'},
    retrait:{ico:'üí∏',bg:'rgba(255,122,53,.08)',col:'#FF7A35'},
    referral:{ico:'üë•',bg:'rgba(160,100,255,.08)',col:'#A064FF'},
    coffre_depot:{ico:'üè¶',bg:'rgba(245,200,66,.08)',col:'#F5C842'},
    coffre_retrait:{ico:'üè¶',bg:'rgba(0,209,102,.08)',col:'#00D166'},
  };
  const list=document.getElementById('hist-mini');
  try{
    const{data,error}=await sb.from('transactions').select('*').eq('user_id',cu.id).order('created_at',{ascending:false}).limit(10);
    if(error||!data?.length){list.innerHTML='<div style="text-align:center;padding:16px;color:var(--text3);font-size:13px">Aucune transaction</div>';return;}
    list.innerHTML=data.map(t=>{
      const m=typeMap[t.type]||{ico:'üíº',bg:'rgba(0,201,192,.08)',col:'#00C9C0'};
      const isNeg=t.type==='investissement'||t.type==='retrait'||t.type==='coffre_depot';
      const d=new Date(t.created_at);
      const ds=d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})+' '+d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
      return `<div class="hm-item" style="background:${m.bg}"><div class="hm-ico" style="background:rgba(0,0,0,.2)">${m.ico}</div><div class="hm-info"><div class="hm-type">${t.label||t.type}</div><div class="hm-date">${ds}</div></div><div class="hm-amount" style="color:${m.col}">${isNeg?'-':'+'}${fmt(t.amount)} F</div></div>`;
    }).join('');
  }catch(e){list.innerHTML='<div style="text-align:center;padding:16px;color:var(--text3)">Historique indisponible</div>';}
}

function buildRefCode(){
  if(!cu)return;
  const code='SYL-'+cu.id.replace(/-/g,'').substring(0,6).toUpperCase();
  const link=window.location.origin+'/index.html?ref='+code;
  document.getElementById('ref-code').textContent=code;
  document.getElementById('ref-link').textContent=link;
}

function copyCode(){navigator.clipboard.writeText(document.getElementById('ref-code').textContent).then(()=>showToast('‚úì Code copi√© !'));}
function shareRef(){
  const link=document.getElementById('ref-link').textContent;
  const code=document.getElementById('ref-code').textContent;
  if(navigator.share){navigator.share({title:'Rejoins SYLLA !',text:'Rejoins-moi sur SYLLA avec mon code '+code+' et re√ßois 1 000 FCFA de bonus !',url:link});}
  else{navigator.clipboard.writeText(link).then(()=>showToast('‚úì Lien copi√© !'));}
}

document.getElementById('form-edit').addEventListener('submit',async e=>{
  e.preventDefault();
  const nom=document.getElementById('edit-nom').value.trim();
  const tel=document.getElementById('edit-tel').value.trim();
  const btn=document.getElementById('edit-btn');
  hide('edit-ok','edit-err');
  btn.disabled=true;btn.innerHTML='<span class="ld"></span>Sauvegarde‚Ä¶';
  try{
    await sb.auth.updateUser({data:{full_name:nom,phone:tel}});
    await sb.from('profiles').upsert({id:cu.id,full_name:nom,phone:tel,email:cu.email,created_at:new Date().toISOString()});
    show('edit-ok');
    document.getElementById('profile-name').textContent=nom||'Investisseur';
    document.getElementById('avatar-big').textContent=(nom[0]||'S').toUpperCase();
    showToast('‚úì Profil mis √† jour !');
  }catch(err){document.getElementById('edit-emsg').textContent=err.message||'Erreur.';show('edit-err');}
  finally{btn.disabled=false;btn.innerHTML='üíæ Sauvegarder';}
});

document.getElementById('form-pwd').addEventListener('submit',async e=>{
  e.preventDefault();
  const np=document.getElementById('new-pwd').value;
  const cp=document.getElementById('conf-pwd').value;
  const btn=document.getElementById('pwd-btn');
  hide('pwd-ok','pwd-err');
  if(np!==cp){document.getElementById('pwd-emsg').textContent='Les mots de passe ne correspondent pas.';show('pwd-err');return;}
  if(np.length<8){document.getElementById('pwd-emsg').textContent='Minimum 8 caract√®res.';show('pwd-err');return;}
  btn.disabled=true;btn.innerHTML='<span class="ld"></span>Mise √† jour‚Ä¶';
  try{
    const{error}=await sb.auth.updateUser({password:np});
    if(error)throw error;
    show('pwd-ok');
    document.getElementById('new-pwd').value='';document.getElementById('conf-pwd').value='';
    showToast('‚úì Mot de passe mis √† jour !');
  }catch(err){document.getElementById('pwd-emsg').textContent=err.message||'Erreur.';show('pwd-err');}
  finally{btn.disabled=false;btn.innerHTML='üîí Mettre √† jour';}
});

async function logout(){await sb.auth.signOut();window.location.href='index.html';}
function toggle(h){h.closest('.sec-block').classList.toggle('open');}
function show(id){const e=document.getElementById(id);if(e)e.classList.add('show');}
function hide(...ids){ids.forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('show');});}
function fmt(n){return Number(n).toLocaleString('fr-FR');}
function fmtShort(n){if(n>=1000000)return (n/1000000).toFixed(1)+'M';if(n>=1000)return (n/1000).toFixed(1)+'K';return String(Math.round(n));}
let toastT=null;
function showToast(msg,err=false){const t=document.getElementById('toast');t.textContent=msg;err?t.classList.add('err'):t.classList.remove('err');t.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),3000);}

init();
</script>
</body>
</html>
