<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SYLLA ‚Äî Mon Profil</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@300;400;500;600;700&family=Outfit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --purple:#A064FF;--purple-l:#C084FC;--purple-d:#7C3AED;
  --teal:#00C9C0;--teal-l:#00EDDE;
  --orange:#FF7A35;--gold:#F5C842;--red:#FF3B4E;
  --green:#00D166;
  --bg:#080610;--bg2:#0E0B1A;--bg3:#140E25;
  --text:#F5F0FF;--text2:#9B85C4;--text3:#4A3878;
  --nav-h:70px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:calc(var(--nav-h)+24px);}

.bg-mesh{position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 60% 50% at 70% 0%, rgba(160,100,255,.14) 0%,transparent 60%),
    radial-gradient(ellipse 50% 55% at 5% 80%, rgba(0,201,192,.08) 0%,transparent 55%),
    radial-gradient(ellipse 70% 70% at 50% 50%, rgba(160,100,255,.04) 0%,transparent 80%),
    linear-gradient(160deg,#080610 0%,#0E0B1A 55%,#0A0914 100%);}
.bg-grid{position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:linear-gradient(rgba(160,100,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(160,100,255,.04) 1px,transparent 1px);
  background-size:50px 50px;}

/* LOADING */
.loading-screen{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .5s,visibility .5s;}
.loading-screen.hide{opacity:0;visibility:hidden;pointer-events:none;}
.load-logo{font-family:'Bebas Neue',cursive;font-size:52px;letter-spacing:8px;background:linear-gradient(135deg,var(--purple),var(--teal-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:pulse 1.5s ease-in-out infinite;}
.load-bar{width:120px;height:2px;background:rgba(160,100,255,.15);border-radius:2px;overflow:hidden;}
.load-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--teal));border-radius:2px;animation:lf 1.5s ease-in-out infinite;}
@keyframes lf{0%{width:0%;margin-left:0;}50%{width:100%;margin-left:0;}100%{width:0%;margin-left:100%;}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
@keyframes spin{to{transform:rotate(360deg);}}

.page{position:relative;z-index:2;padding:0 16px 20px;}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 12px;position:sticky;top:0;z-index:50;background:rgba(8,6,16,.93);backdrop-filter:blur(20px);border-bottom:1px solid rgba(160,100,255,.12);margin:0 -16px 0;}
.back-btn{display:flex;align-items:center;gap:8px;font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--purple-l);text-decoration:none;padding:8px 14px;border:1px solid rgba(160,100,255,.3);border-radius:20px;transition:all .2s;}
.back-btn:hover{background:rgba(160,100,255,.08);}
.page-title-top{font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:4px;background:linear-gradient(135deg,var(--purple-l),var(--teal-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logout-btn{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--red);padding:8px 14px;border:1px solid rgba(255,59,78,.25);border-radius:20px;background:transparent;cursor:pointer;transition:all .2s;}
.logout-btn:hover{background:rgba(255,59,78,.08);}

/* HERO PROFILE */
.profile-hero{
  text-align:center;padding:28px 16px 24px;
  animation:fadeUp .6s ease both;
}
.avatar-wrap{position:relative;width:90px;height:90px;margin:0 auto 14px;}
.avatar-big{
  width:90px;height:90px;border-radius:50%;
  background:linear-gradient(135deg,var(--purple-d),var(--purple),var(--purple-l));
  display:flex;align-items:center;justify-content:center;
  font-family:'Bebas Neue',cursive;font-size:36px;letter-spacing:2px;color:#fff;
  box-shadow:0 0 0 3px rgba(160,100,255,.25),0 0 30px rgba(160,100,255,.2);
}
.avatar-ring{
  position:absolute;inset:-6px;border-radius:50%;
  border:2px solid transparent;
  background:linear-gradient(135deg,var(--purple),var(--teal),var(--orange)) border-box;
  -webkit-mask:linear-gradient(#fff 0 0) padding-box,linear-gradient(#fff 0 0);
  -webkit-mask-composite:destination-out;mask-composite:exclude;
  animation:spin 4s linear infinite;
}
.avatar-edit{
  position:absolute;bottom:0;right:0;
  width:26px;height:26px;border-radius:50%;
  background:linear-gradient(135deg,var(--purple-d),var(--purple));
  border:2px solid var(--bg);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;cursor:pointer;
  box-shadow:0 2px 10px rgba(160,100,255,.3);
}
.profile-name{font-family:'Bebas Neue',cursive;font-size:30px;letter-spacing:3px;background:linear-gradient(135deg,#fff,var(--purple-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.profile-email{font-size:13px;font-weight:300;color:var(--text2);margin-top:4px;}
.profile-since{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-top:6px;}

/* VIP BADGE */
.vip-badge{
  display:inline-flex;align-items:center;gap:8px;
  border-radius:100px;padding:8px 20px;margin-top:12px;
  font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;
  animation:glow 2.5s ease-in-out infinite;
}
@keyframes glow{0%,100%{box-shadow:0 4px 20px rgba(245,200,66,.1);}50%{box-shadow:0 4px 30px rgba(245,200,66,.3);}}

/* STATS ROW */
.stats-row{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:1px;background:rgba(255,255,255,.04);
  border-radius:18px;overflow:hidden;
  border:1px solid rgba(160,100,255,.12);
  margin:20px 0;
  animation:fadeUp .6s .1s ease both;
}
.sr-item{background:rgba(0,0,0,.3);padding:16px 8px;text-align:center;}
.sr-val{font-family:'Bebas Neue',cursive;font-size:26px;letter-spacing:1px;line-height:1;}
.sr-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-top:4px;}

/* SECTION */
.sec-block{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(160,100,255,.1);
  border-radius:20px;overflow:hidden;
  margin-bottom:14px;
  animation:fadeUp .6s ease both;
}
.sec-block:nth-child(3){animation-delay:.05s;}
.sec-block:nth-child(4){animation-delay:.1s;}
.sec-block:nth-child(5){animation-delay:.15s;}
.sec-block:nth-child(6){animation-delay:.2s;}

.sec-header{
  display:flex;align-items:center;gap:12px;
  padding:16px 18px;
  border-bottom:1px solid rgba(160,100,255,.08);
  cursor:pointer;user-select:none;
}
.sec-ico{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.sec-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--text);flex:1;}
.sec-arrow{color:var(--text3);font-size:14px;transition:transform .25s;}
.sec-block.open .sec-arrow{transform:rotate(90deg);}
.sec-body{display:none;padding:18px;}
.sec-block.open .sec-body{display:block;}

/* FORM FIELDS */
.field-grp{margin-bottom:14px;}
.field-lbl{display:block;font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--purple-l);margin-bottom:7px;opacity:.8;}
.field-inp{width:100%;background:rgba(160,100,255,.05);border:1.5px solid rgba(160,100,255,.18);border-radius:10px;padding:12px 15px;font-family:'Outfit',sans-serif;font-size:14px;font-weight:300;color:var(--text);outline:none;transition:all .25s;}
.field-inp::placeholder{color:rgba(155,133,196,.3);font-size:13px;}
.field-inp:focus{border-color:var(--purple-l);background:rgba(160,100,255,.09);box-shadow:0 0 0 4px rgba(160,100,255,.1);}
.field-inp:read-only{opacity:.6;cursor:default;}

/* REFERRAL BOX */
.ref-box{
  background:linear-gradient(135deg,rgba(245,200,66,.08),rgba(160,100,255,.05));
  border:1px solid rgba(245,200,66,.25);border-radius:14px;
  padding:16px;
}
.ref-label{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(245,200,66,.8);margin-bottom:8px;}
.ref-code{
  font-family:'Bebas Neue',cursive;font-size:28px;letter-spacing:6px;
  color:var(--gold);margin-bottom:12px;
  word-break:break-all;
}
.ref-link{font-size:12px;font-weight:300;color:var(--text2);margin-bottom:12px;word-break:break-all;line-height:1.4;}
.ref-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.ref-btn{padding:10px;border-radius:10px;border:none;cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;transition:all .2s;}
.rb-copy{background:rgba(245,200,66,.12);color:var(--gold);border:1px solid rgba(245,200,66,.25);}
.rb-copy:hover{background:rgba(245,200,66,.2);}
.rb-share{background:linear-gradient(135deg,var(--purple-d),var(--purple));color:#fff;}
.rb-share:hover{transform:translateY(-1px);}

.ref-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;}
.rs-item{background:rgba(0,0,0,.3);border-radius:12px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,.05);}
.rs-val{font-family:'Bebas Neue',cursive;font-size:24px;letter-spacing:1px;}
.rs-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-top:3px;}

/* HISTORY IN PROFILE */
.hist-mini{display:flex;flex-direction:column;gap:8px;}
.hm-item{display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(0,0,0,.2);border-radius:12px;border:1px solid rgba(255,255,255,.04);}
.hm-ico{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.hm-info{flex:1;min-width:0;}
.hm-type{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:.5px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hm-date{font-size:10px;font-weight:300;color:var(--text3);margin-top:1px;}
.hm-amount{font-family:'Bebas Neue',cursive;font-size:17px;letter-spacing:1px;flex-shrink:0;}

/* SAVE BTN */
.save-btn{width:100%;padding:14px;border:none;border-radius:12px;cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#fff;background:linear-gradient(135deg,var(--purple-d),var(--purple));box-shadow:0 8px 24px rgba(160,100,255,.28);position:relative;overflow:hidden;transition:all .3s;margin-top:4px;}
.save-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s;}
.save-btn:hover::before{left:100%;}
.save-btn:hover{transform:translateY(-2px);}
.save-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
.ld{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px;}

/* TOAST */
.toast{
  position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);
  background:rgba(0,209,102,.9);backdrop-filter:blur(12px);
  color:#fff;padding:10px 22px;border-radius:100px;
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:1.5px;
  z-index:500;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.err{background:rgba(255,59,78,.9);}

/* ALERTS */
.al{display:none;align-items:center;gap:10px;padding:11px 14px;border-radius:10px;font-size:13px;margin-bottom:14px;animation:sld .3s ease;}
.al.show{display:flex;}
.al-ok{background:rgba(0,209,102,.1);border:1px solid rgba(0,209,102,.3);color:#4ADE80;}
.al-err{background:rgba(255,59,78,.08);border:1px solid rgba(255,59,78,.25);color:#FF6B7A;}
@keyframes sld{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}

/* DANGER ZONE */
.danger-zone{background:rgba(255,59,78,.05);border:1px solid rgba(255,59,78,.15);border-radius:16px;padding:16px;}
.dz-title{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--red);margin-bottom:12px;}
.dz-btn{width:100%;padding:13px;border-radius:12px;border:1.5px solid rgba(255,59,78,.3);background:transparent;color:var(--red);cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;transition:all .2s;}
.dz-btn:hover{background:rgba(255,59,78,.1);}

/* BOT NAV */
.bot-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;height:var(--nav-h);background:rgba(8,6,16,.94);backdrop-filter:blur(24px);border-top:1px solid rgba(160,100,255,.12);display:grid;grid-template-columns:repeat(4,1fr);box-shadow:0 -8px 32px rgba(0,0,0,.5);}
.nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;text-decoration:none;transition:all .2s;padding:8px 4px;position:relative;}
.nav-item::before{content:'';position:absolute;top:0;left:20%;right:20%;height:2px;border-radius:0 0 4px 4px;background:linear-gradient(90deg,var(--purple),var(--teal-l));transform:scaleX(0);transition:transform .3s;}
.nav-item.active::before{transform:scaleX(1);}
.nav-item.active .nav-ico,.nav-item.active .nav-lbl{color:var(--purple-l);}
.nav-ico{font-size:20px;color:var(--text3);transition:color .2s;}
.nav-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);transition:color .2s;}
</style>
</head>
<body>

<div class="loading-screen" id="loader">
  <div class="load-logo">PROFIL</div>
  <div class="load-bar"><div class="load-fill"></div></div>
</div>

<div class="bg-mesh"></div><div class="bg-grid"></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<div class="page">
  <!-- TOPBAR -->
  <div class="topbar">
    <a href="dashboard.html" class="back-btn">‚Üê Accueil</a>
    <div class="page-title-top">MON PROFIL</div>
    <button class="logout-btn" onclick="logout()">D√©connexion</button>
  </div>

  <!-- HERO -->
  <div class="profile-hero">
    <div class="avatar-wrap">
      <div class="avatar-big" id="avatar-big">S</div>
      <div class="avatar-ring"></div>
      <div class="avatar-edit">‚úèÔ∏è</div>
    </div>
    <div class="profile-name" id="profile-name">Chargement‚Ä¶</div>
    <div class="profile-email" id="profile-email">‚Äî</div>
    <div class="profile-since" id="profile-since">Membre depuis ‚Äî</div>
    <div class="vip-badge" id="vip-badge" style="background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.25);color:var(--gold);">
      ü•â Membre Bronze
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-row">
    <div class="sr-item">
      <div class="sr-val" style="color:var(--teal)" id="stat-balance">0</div>
      <div class="sr-lbl">Solde (F)</div>
    </div>
    <div class="sr-item">
      <div class="sr-val" style="color:var(--purple-l)" id="stat-refs">0</div>
      <div class="sr-lbl">Filleuls</div>
    </div>
    <div class="sr-item">
      <div class="sr-val" style="color:var(--gold)" id="stat-plans">0</div>
      <div class="sr-lbl">Plans actifs</div>
    </div>
  </div>

  <!-- EDIT PROFILE -->
  <div class="sec-block open">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(160,100,255,.12)">üë§</div>
      <div class="sec-title">Modifier le profil</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="al al-ok" id="edit-ok"><span>‚úì</span> Profil mis √† jour avec succ√®s !</div>
      <div class="al al-err" id="edit-err"><span>‚úï</span><span id="edit-emsg">Erreur.</span></div>
      <form id="form-edit">
        <div class="field-grp">
          <label class="field-lbl">Nom complet</label>
          <input class="field-inp" type="text" id="edit-nom" placeholder="Votre nom complet">
        </div>
        <div class="field-grp">
          <label class="field-lbl">Num√©ro de t√©l√©phone</label>
          <input class="field-inp" type="tel" id="edit-tel" placeholder="+225 00 000 000">
        </div>
        <div class="field-grp">
          <label class="field-lbl">Email (lecture seule)</label>
          <input class="field-inp" type="email" id="edit-email" readonly>
        </div>
        <button class="save-btn" type="submit" id="edit-btn">üíæ Sauvegarder les modifications</button>
      </form>
    </div>
  </div>

  <!-- REFERRAL -->
  <div class="sec-block">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(245,200,66,.1)">üéÅ</div>
      <div class="sec-title">Mon code de parrainage</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="ref-box">
        <div class="ref-label">üè∑Ô∏è Votre code unique</div>
        <div class="ref-code" id="ref-code">SYLLA-‚Äî‚Äî</div>
        <div class="ref-link" id="ref-link">Chargement du lien‚Ä¶</div>
        <div class="ref-btns">
          <button class="ref-btn rb-copy" onclick="copyCode()">üìã Copier le code</button>
          <button class="ref-btn rb-share" onclick="shareRef()">üîó Partager</button>
        </div>
      </div>
      <div class="ref-stats">
        <div class="rs-item">
          <div class="rs-val" style="color:var(--purple-l)" id="ref-count">0</div>
          <div class="rs-lbl">Filleuls parrain√©s</div>
        </div>
        <div class="rs-item">
          <div class="rs-val" style="color:var(--gold)" id="ref-earned">0 F</div>
          <div class="rs-lbl">Gains parrainage</div>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORY -->
  <div class="sec-block">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(0,201,192,.1)">üìã</div>
      <div class="sec-title">Historique des transactions</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="hist-mini" id="hist-mini">
        <div style="text-align:center;padding:16px;color:var(--text3);font-size:13px;">Chargement‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD -->
  <div class="sec-block">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(255,122,53,.1)">üîê</div>
      <div class="sec-title">Changer le mot de passe</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="al al-ok" id="pwd-ok"><span>‚úì</span> Mot de passe mis √† jour !</div>
      <div class="al al-err" id="pwd-err"><span>‚úï</span><span id="pwd-emsg">Erreur.</span></div>
      <form id="form-pwd">
        <div class="field-grp">
          <label class="field-lbl">Nouveau mot de passe</label>
          <input class="field-inp" type="password" id="new-pwd" placeholder="Minimum 8 caract√®res" minlength="8">
        </div>
        <div class="field-grp">
          <label class="field-lbl">Confirmer le mot de passe</label>
          <input class="field-inp" type="password" id="conf-pwd" placeholder="R√©p√©tez le mot de passe">
        </div>
        <button class="save-btn" type="submit" id="pwd-btn" style="background:linear-gradient(135deg,#CC5A10,var(--orange));box-shadow:0 8px 24px rgba(255,122,53,.25);">üîí Mettre √† jour</button>
      </form>
    </div>
  </div>

  <!-- DANGER ZONE -->
  <div class="sec-block">
    <div class="sec-header" onclick="toggle(this)">
      <div class="sec-ico" style="background:rgba(255,59,78,.1)">‚ö†Ô∏è</div>
      <div class="sec-title">Zone de danger</div>
      <span class="sec-arrow">‚Ä∫</span>
    </div>
    <div class="sec-body">
      <div class="danger-zone">
        <div class="dz-title">Actions irr√©versibles</div>
        <button class="dz-btn" onclick="logout()">üö™ Se d√©connecter de tous les appareils</button>
      </div>
    </div>
  </div>

</div>

<!-- BOT NAV -->
<nav class="bot-nav">
  <a href="dashboard.html" class="nav-item"><span class="nav-ico">üè†</span><span class="nav-lbl">Accueil</span></a>
  <a href="plan.html" class="nav-item"><span class="nav-ico">üöÄ</span><span class="nav-lbl">Plans</span></a>
  <a href="retrait.html" class="nav-item"><span class="nav-ico">üí∏</span><span class="nav-lbl">Retrait</span></a>
  <a href="profil.html" class="nav-item active"><span class="nav-ico">üë§</span><span class="nav-lbl">Profil</span></a>
</nav>

<script>
const{createClient}=supabase;
const sb=createClient('https://fqiotqrraobmsrcyewsi.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxaW90cXJyYW9ibXNyY3lld3NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjA3NzUsImV4cCI6MjA4NzM5Njc3NX0.pmvaQikEDEj705o7kBBWwkLwAoZ62D-GoxjFm5HEHNc');

let currentUser=null,userProfile=null;

/* ‚îÄ‚îÄ VIP LEVELS ‚îÄ‚îÄ */
const VIP_LEVELS=[
  {min:0,     label:'ü•â Membre Bronze', bg:'rgba(205,127,50,.1)', border:'rgba(205,127,50,.3)', color:'#CD7F32'},
  {min:10000, label:'ü•à Membre Argent', bg:'rgba(192,192,192,.1)', border:'rgba(192,192,192,.3)', color:'#C0C0C0'},
  {min:50000, label:'ü•á Membre Or',     bg:'rgba(245,200,66,.1)',  border:'rgba(245,200,66,.3)',  color:'#F5C842'},
  {min:150000,label:'üíé Membre Diamant',bg:'rgba(160,100,255,.15)',border:'rgba(160,100,255,.4)', color:'#A064FF'},
];
function getVip(total){
  let v=VIP_LEVELS[0];
  VIP_LEVELS.forEach(l=>{if(total>=l.min)v=l;});
  return v;
}

async function init(){
  const{data:{session}}=await sb.auth.getSession();
  if(!session){window.location.href='index.html';return;}
  currentUser=session.user;
  await loadProfile();
  await loadStats();
  await loadHistory();
  buildRefCode();
  document.getElementById('loader').classList.add('hide');
}

async function loadProfile(){
  let name=currentUser.user_metadata?.full_name||'';
  let phone=currentUser.user_metadata?.phone||'';
  try{
    const{data}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
    if(data){name=data.full_name||name;phone=data.phone||phone;}
  }catch(e){}
  userProfile={name,phone,email:currentUser.email};
  const initial=(name[0]||'S').toUpperCase();
  document.getElementById('avatar-big').textContent=initial;
  document.getElementById('profile-name').textContent=name||'Investisseur';
  document.getElementById('profile-email').textContent=currentUser.email;
  const created=new Date(currentUser.created_at);
  document.getElementById('profile-since').textContent='Membre depuis le '+created.toLocaleDateString('fr-FR',{day:'2-digit',month:'long',year:'numeric'});
  document.getElementById('edit-nom').value=name;
  document.getElementById('edit-tel').value=phone;
  document.getElementById('edit-email').value=currentUser.email;
}

async function loadStats(){
  let total=1000,plans=0;
  try{
    const[txRes,invRes]=await Promise.all([
      sb.from('transactions').select('amount,type').eq('user_id',currentUser.id),
      sb.from('investments').select('id').eq('user_id',currentUser.id).eq('status','active')
    ]);
    if(txRes.data&&txRes.data.length){
      total=0;
      txRes.data.forEach(t=>{
        if(['bonus_bienvenue','depot','gain','referral'].includes(t.type))total+=Number(t.amount);
        if(t.type==='retrait')total-=Number(t.amount);
        if(t.type==='investissement')total-=Number(t.amount);
      });
    }
    plans=invRes.data?.length||0;
  }catch(e){}
  total=Math.max(0,total);
  document.getElementById('stat-balance').textContent=fmtShort(total);
  document.getElementById('stat-plans').textContent=plans;
  const vip=getVip(total);
  const badge=document.getElementById('vip-badge');
  badge.textContent=vip.label;
  badge.style.background=vip.bg;badge.style.border='1px solid '+vip.border;badge.style.color=vip.color;
}

async function loadHistory(){
  const typeMap={bonus_bienvenue:{ico:'üéÅ',cls:'h-gold',bg:'rgba(245,200,66,.12)'},depot:{ico:'üí∞',cls:'h-green',bg:'rgba(74,222,128,.08)'},investissement:{ico:'üìà',cls:'h-teal',bg:'rgba(0,201,192,.08)'},gain:{ico:'‚ú®',cls:'h-green',bg:'rgba(74,222,128,.08)'},retrait:{ico:'üí∏',cls:'h-orange',bg:'rgba(255,122,53,.08)'},referral:{ico:'üë•',cls:'h-purple',bg:'rgba(160,100,255,.08)'}};
  const colMap={h-gold:'#F5C842','h-green':'#4ADE80','h-teal':'#00C9C0','h-orange':'#FF7A35','h-purple':'#A064FF'};
  try{
    const{data}=await sb.from('transactions').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}).limit(10);
    const list=document.getElementById('hist-mini');
    if(!data||!data.length){list.innerHTML='<div style="text-align:center;padding:16px;color:var(--text3);font-size:13px;">Aucune transaction</div>';return;}
    const refTotal=data.filter(t=>t.type==='referral').reduce((s,t)=>s+Number(t.amount),0);
    const refCount=0;
    document.getElementById('ref-count').textContent=refCount;
    document.getElementById('ref-earned').textContent=fmt(refTotal)+' F';
    list.innerHTML=data.map(t=>{
      const m=typeMap[t.type]||{ico:'üíº',cls:'h-teal',bg:'rgba(0,201,192,.08)'};
      const color=colMap[m.cls]||'#00C9C0';
      const isNeg=t.type==='investissement'||t.type==='retrait';
      const sign=isNeg?'-':'+';
      const d=new Date(t.created_at);
      const ds=d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      return `<div class="hm-item" style="${m.bg?'background:'+m.bg:''}">
        <div class="hm-ico" style="background:rgba(0,0,0,.2)">${m.ico}</div>
        <div class="hm-info"><div class="hm-type">${t.label||t.type}</div><div class="hm-date">${ds}</div></div>
        <div class="hm-amount" style="color:${color}">${sign}${fmt(t.amount)} F</div>
      </div>`;
    }).join('');
    document.getElementById('stat-refs').textContent=refCount;
  }catch(e){document.getElementById('hist-mini').innerHTML='<div style="text-align:center;padding:16px;color:var(--text3)">Aucune transaction</div>';}
}

function buildRefCode(){
  const uid=currentUser.id.replace(/-/g,'').substring(0,6).toUpperCase();
  const code='SYLLA-'+uid;
  const link=window.location.origin+'/index.html?ref='+code;
  document.getElementById('ref-code').textContent=code;
  document.getElementById('ref-link').textContent=link;
}

function copyCode(){
  const code=document.getElementById('ref-code').textContent;
  navigator.clipboard.writeText(code).then(()=>showToast('‚úì Code copi√© !'));
}

function shareRef(){
  const link=document.getElementById('ref-link').textContent;
  const code=document.getElementById('ref-code').textContent;
  if(navigator.share){
    navigator.share({title:'SYLLA ‚Äî Rejoignez-moi !',text:'Rejoignez SYLLA avec mon code '+code+' et recevez un bonus de bienvenue !',url:link});
  }else{
    navigator.clipboard.writeText(link).then(()=>showToast('‚úì Lien copi√© !'));
  }
}

/* EDIT PROFILE */
document.getElementById('form-edit').addEventListener('submit',async e=>{
  e.preventDefault();
  const nom=document.getElementById('edit-nom').value.trim();
  const tel=document.getElementById('edit-tel').value.trim();
  const btn=document.getElementById('edit-btn');
  hide('edit-ok','edit-err');
  btn.disabled=true;btn.innerHTML='<span class="ld"></span>Sauvegarde‚Ä¶';
  try{
    await sb.auth.updateUser({data:{full_name:nom,phone:tel}});
    await sb.from('profiles').upsert({id:currentUser.id,full_name:nom,phone:tel,email:currentUser.email});
    show('edit-ok');
    document.getElementById('profile-name').textContent=nom;
    document.getElementById('avatar-big').textContent=(nom[0]||'S').toUpperCase();
    showToast('‚úì Profil mis √† jour !');
  }catch(err){document.getElementById('edit-emsg').textContent=err.message||'Erreur.';show('edit-err');}
  finally{btn.disabled=false;btn.innerHTML='üíæ Sauvegarder les modifications';}
});

/* CHANGE PASSWORD */
document.getElementById('form-pwd').addEventListener('submit',async e=>{
  e.preventDefault();
  const np=document.getElementById('new-pwd').value;
  const cp=document.getElementById('conf-pwd').value;
  const btn=document.getElementById('pwd-btn');
  hide('pwd-ok','pwd-err');
  if(np!==cp){document.getElementById('pwd-emsg').textContent='Les mots de passe ne correspondent pas.';show('pwd-err');return;}
  if(np.length<8){document.getElementById('pwd-emsg').textContent='Le mot de passe doit contenir au moins 8 caract√®res.';show('pwd-err');return;}
  btn.disabled=true;btn.innerHTML='<span class="ld"></span>Mise √† jour‚Ä¶';
  try{
    const{error}=await sb.auth.updateUser({password:np});
    if(error)throw error;
    show('pwd-ok');
    document.getElementById('new-pwd').value='';
    document.getElementById('conf-pwd').value='';
    showToast('‚úì Mot de passe mis √† jour !');
  }catch(err){document.getElementById('pwd-emsg').textContent=err.message||'Erreur.';show('pwd-err');}
  finally{btn.disabled=false;btn.innerHTML='üîí Mettre √† jour';}
});

async function logout(){
  await sb.auth.signOut();window.location.href='index.html';
}

/* ACCORDION */
function toggle(header){
  const block=header.closest('.sec-block');
  block.classList.toggle('open');
}

/* HELPERS */
function show(id){const e=document.getElementById(id);if(e)e.classList.add('show');}
function hide(...ids){ids.forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('show');});}
function fmt(n){return Number(n).toLocaleString('fr-FR');}
function fmtShort(n){if(n>=1000000)return (n/1000000).toFixed(1)+'M';if(n>=1000)return (n/1000).toFixed(1)+'K';return String(Math.round(n));}

let toastTimer=null;
function showToast(msg,isErr=false){
  const t=document.getElementById('toast');
  t.textContent=msg;
  if(isErr)t.classList.add('err');else t.classList.remove('err');
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),3000);
}

init();
</script>
</body>
</html>
