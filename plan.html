<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SYLLA ‚Äî Plans d'Investissement</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@300;400;500;600;700&family=Outfit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --teal:#00C9C0;--teal-l:#00EDDE;--teal-d:#008E89;
  --orange:#FF7A35;--amber:#FFB830;--red:#FF3B4E;
  --gold:#F5C842;--purple:#A064FF;--sky:#38BDF8;
  --bg:#07100F;--bg2:#0B1918;--bg3:#0F2220;
  --card:rgba(255,255,255,0.04);--card-b:rgba(0,201,192,0.18);
  --text:#E8FFFD;--text2:#7EC8C4;--text3:#3D7A77;
  --nav-h:70px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:calc(var(--nav-h) + 16px);}

/* BG */
.bg-mesh{position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 55% 50% at 80% 5%, rgba(0,237,222,.1) 0%,transparent 60%),
    radial-gradient(ellipse 45% 55% at 10% 85%, rgba(255,122,53,.07) 0%,transparent 55%),
    radial-gradient(ellipse 70% 70% at 50% 50%, rgba(0,201,192,.04) 0%,transparent 80%),
    linear-gradient(160deg,#07100F 0%,#0C1E1C 50%,#0A1715 100%);}
.bg-grid{position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:linear-gradient(rgba(0,201,192,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,201,192,.04) 1px,transparent 1px);
  background-size:50px 50px;}

/* LOADING */
.loading-screen{position:fixed;inset:0;z-index:999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .5s,visibility .5s;}
.loading-screen.hide{opacity:0;visibility:hidden;pointer-events:none;}
.load-logo{font-family:'Bebas Neue',cursive;font-size:60px;letter-spacing:8px;background:linear-gradient(135deg,var(--teal),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:pulse 1.5s ease-in-out infinite;}
.load-bar{width:120px;height:2px;background:rgba(0,201,192,.15);border-radius:2px;overflow:hidden;}
.load-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--teal-l));border-radius:2px;animation:loadFill 1.5s ease-in-out infinite;}
@keyframes loadFill{0%{width:0%;margin-left:0;}50%{width:100%;margin-left:0;}100%{width:0%;margin-left:100%;}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

/* PAGE */
.page{position:relative;z-index:2;padding:0 14px 20px;}

/* TOP BAR */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 14px 12px;
  position:sticky;top:0;z-index:50;
  background:rgba(7,16,15,.9);backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(0,201,192,.1);
  margin:0 -14px 20px;
}
.back-btn{
  display:flex;align-items:center;gap:8px;
  font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;color:var(--teal);text-decoration:none;
  padding:8px 14px;border:1px solid rgba(0,201,192,.25);border-radius:20px;
  transition:all .2s;
}
.back-btn:hover{background:rgba(0,201,192,.08);}
.page-title{font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:4px;background:linear-gradient(135deg,var(--teal),var(--teal-l));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.balance-pill{
  display:flex;align-items:center;gap:6px;
  background:rgba(0,201,192,.08);border:1px solid rgba(0,201,192,.2);
  border-radius:20px;padding:7px 14px;
  font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;
  letter-spacing:1.5px;color:var(--teal);
}
.balance-pill span{font-size:13px;}

/* HERO SECTION */
.hero-sec{
  text-align:center;padding:4px 0 20px;
}
.hero-sec h1{
  font-family:'Bebas Neue',cursive;
  font-size:clamp(32px,8vw,52px);letter-spacing:4px;
  background:linear-gradient(135deg,#fff 0%,var(--teal-l) 50%,var(--teal) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  line-height:1;
}
.hero-sec p{font-size:13px;font-weight:300;color:var(--text2);margin-top:8px;max-width:300px;margin-inline:auto;line-height:1.6;}

/* PLANS STACK */
.plans-list{display:flex;flex-direction:column;gap:16px;}

/* PLAN CARD */
.plan-card{
  border-radius:24px;
  overflow:hidden;
  position:relative;
  border:1.5px solid var(--pb, rgba(0,201,192,.2));
  background:var(--bg2);
  transition:transform .25s,box-shadow .25s;
  animation:fadeUp .5s ease both;
  cursor:default;
}
.plan-card:hover{transform:translateY(-3px);box-shadow:0 20px 50px var(--ps,rgba(0,201,192,.15));}
.plan-card:nth-child(1){animation-delay:.05s;}
.plan-card:nth-child(2){animation-delay:.1s;}
.plan-card:nth-child(3){animation-delay:.15s;}
.plan-card:nth-child(4){animation-delay:.2s;}
.plan-card:nth-child(5){animation-delay:.25s;}

/* Plane image area */
.plane-img-wrap{
  position:relative;height:180px;overflow:hidden;
}
.plane-img-wrap::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(7,16,15,0) 20%,rgba(7,16,15,.7) 70%,var(--bg2) 100%);
}
.plane-img{
  width:100%;height:100%;object-fit:cover;object-position:center 40%;
  transition:transform .4s ease;
}
.plan-card:hover .plane-img{transform:scale(1.04);}

/* Plan badge overlay */
.plan-badge-wrap{
  position:absolute;top:14px;left:14px;z-index:2;
  display:flex;align-items:center;gap:8px;
}
.plan-badge{
  font-family:'Bebas Neue',cursive;
  font-size:13px;letter-spacing:3px;
  padding:5px 14px;border-radius:100px;
  color:#fff;
}
.tier-badge{
  font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;padding:5px 12px;border-radius:100px;
  border:1px solid currentColor;
}

/* Plan body */
.plan-body{padding:0 18px 20px;position:relative;z-index:1;margin-top:-2px;}

.plan-name{
  font-family:'Bebas Neue',cursive;
  font-size:28px;letter-spacing:3px;
  line-height:1;margin-bottom:4px;
}

.plan-plane-name{
  font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;letter-spacing:2px;
  text-transform:uppercase;color:var(--text3);margin-bottom:14px;
}

/* Stats row */
.plan-stats{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  gap:1px;
  background:rgba(255,255,255,.05);
  border-radius:14px;overflow:hidden;
  margin-bottom:14px;border:1px solid rgba(255,255,255,.06);
}
.ps-item{
  background:rgba(0,0,0,.25);
  padding:12px 8px;text-align:center;
}
.ps-val{
  font-family:'Bebas Neue',cursive;
  font-size:20px;letter-spacing:1px;line-height:1;
}
.ps-lbl{
  font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;
  letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);
  margin-top:3px;
}

/* ROI bar */
.roi-row{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.roi-label{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text3);flex-shrink:0;}
.roi-bar{flex:1;height:5px;background:rgba(255,255,255,.07);border-radius:3px;overflow:hidden;}
.roi-fill{height:100%;border-radius:3px;transition:width .8s ease;}
.roi-pct{font-family:'Bebas Neue',cursive;font-size:16px;letter-spacing:1px;flex-shrink:0;}

/* Features */
.plan-features{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
.feat{
  font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;letter-spacing:1.5px;
  text-transform:uppercase;padding:4px 10px;border-radius:6px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);
  color:var(--text2);
}

/* Invest button */
.invest-btn{
  width:100%;padding:14px;border:none;border-radius:14px;
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:4px;
  text-transform:uppercase;cursor:pointer;
  position:relative;overflow:hidden;transition:all .3s;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.invest-btn::before{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
  transition:left .5s;
}
.invest-btn:hover::before{left:100%;}
.invest-btn:hover{transform:translateY(-2px);}
.invest-btn:active{transform:scale(.98);}
.invest-btn.active-plan{
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
  color:var(--text3);cursor:default;
}
.invest-btn.active-plan:hover{transform:none;}
.invest-btn.active-plan::before{display:none;}
.checkmark{font-size:16px;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.modal-overlay{
  position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,.85);backdrop-filter:blur(16px);
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .35s;
}
.modal-overlay.show{opacity:1;pointer-events:all;}
.modal{
  width:100%;max-width:480px;
  background:linear-gradient(160deg,#0D1F1E 0%,#091918 100%);
  border:1.5px solid rgba(0,201,192,.2);
  border-radius:28px 28px 0 0;
  padding:10px 20px 36px;
  transform:translateY(100%);transition:transform .4s cubic-bezier(.34,1.4,.64,1);
  position:relative;overflow:hidden;
}
.modal-overlay.show .modal{transform:translateY(0);}
.modal::before{
  content:'';position:absolute;top:-80px;right:-80px;
  width:200px;height:200px;border-radius:50%;
  border:1px solid rgba(0,201,192,.08);
  animation:spin 20s linear infinite;
}

.modal-handle{width:40px;height:4px;border-radius:2px;background:rgba(255,255,255,.15);margin:14px auto 20px;}

.modal-plane-preview{
  width:100%;height:130px;border-radius:18px;overflow:hidden;
  position:relative;margin-bottom:18px;border:1px solid rgba(255,255,255,.08);
}
.modal-plane-preview img{width:100%;height:100%;object-fit:cover;object-position:center 40%;}
.modal-plane-preview::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(0,201,192,.15),rgba(0,0,0,.4));
}

.modal-plan-name{
  font-family:'Bebas Neue',cursive;font-size:32px;letter-spacing:4px;
  line-height:1;margin-bottom:4px;
}
.modal-plane-type{
  font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;
  letter-spacing:2.5px;text-transform:uppercase;color:var(--text3);margin-bottom:20px;
}

.modal-recap{
  background:rgba(0,0,0,.3);border-radius:16px;
  border:1px solid rgba(255,255,255,.07);
  overflow:hidden;margin-bottom:20px;
}
.recap-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:13px 16px;border-bottom:1px solid rgba(255,255,255,.05);
}
.recap-row:last-child{border-bottom:none;}
.recap-lbl{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);}
.recap-val{font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:1px;}

.modal-warning{
  display:flex;align-items:center;gap:10px;
  background:rgba(255,122,53,.08);border:1px solid rgba(255,122,53,.2);
  border-radius:12px;padding:12px 14px;margin-bottom:18px;
  font-size:12px;font-weight:300;color:rgba(255,200,100,.8);line-height:1.5;
}
.modal-warning .wi{font-size:18px;flex-shrink:0;}

.modal-btns{display:grid;grid-template-columns:1fr 1.6fr;gap:10px;}
.btn-cancel{
  padding:14px;border-radius:14px;border:1.5px solid rgba(255,255,255,.12);
  background:transparent;color:var(--text3);cursor:pointer;
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  transition:all .2s;
}
.btn-cancel:hover{background:rgba(255,255,255,.05);color:var(--text2);}
.btn-confirm{
  padding:14px;border-radius:14px;border:none;cursor:pointer;
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;
  color:#fff;position:relative;overflow:hidden;transition:all .3s;
}
.btn-confirm:hover{transform:translateY(-2px);}
.btn-confirm:disabled{opacity:.6;cursor:not-allowed;transform:none;}
.ld{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px;}

/* SUCCESS MODAL STATE */
.modal-success{display:none;text-align:center;padding:20px 0;}
.modal-success.show{display:block;}
.ms-ico{font-size:56px;margin-bottom:14px;}
.ms-title{font-family:'Bebas Neue',cursive;font-size:36px;letter-spacing:3px;color:var(--teal);}
.ms-msg{font-size:14px;font-weight:300;color:var(--text2);margin-top:8px;line-height:1.5;}
.ms-btn{
  margin-top:20px;padding:13px 32px;border-radius:14px;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--teal-d),var(--teal));
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#fff;
  box-shadow:0 8px 24px rgba(0,201,192,.3);
}

/* BOTTOM NAV */
.bot-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;height:var(--nav-h);background:rgba(7,16,15,.92);backdrop-filter:blur(24px);border-top:1px solid rgba(0,201,192,.15);display:grid;grid-template-columns:repeat(4,1fr);box-shadow:0 -8px 32px rgba(0,0,0,.4);}
.nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;text-decoration:none;transition:all .2s;padding:8px 4px;position:relative;}
.nav-item::before{content:'';position:absolute;top:0;left:20%;right:20%;height:2px;border-radius:0 0 4px 4px;background:linear-gradient(90deg,var(--teal),var(--teal-l));transform:scaleX(0);transition:transform .3s;}
.nav-item.active::before{transform:scaleX(1);}
.nav-item.active .nav-ico,.nav-item.active .nav-lbl{color:var(--teal);}
.nav-ico{font-size:20px;color:var(--text3);transition:color .2s;}
.nav-lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);transition:color .2s;}

@keyframes spin{to{transform:rotate(360deg);}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:rgba(0,201,192,.3);border-radius:4px;}
</style>
</head>
<body>

<div class="loading-screen" id="loader">
  <div class="load-logo">SYLLA</div>
  <div class="load-bar"><div class="load-fill"></div></div>
</div>

<div class="bg-mesh"></div>
<div class="bg-grid"></div>

<!-- CONFIRMATION MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-handle"></div>

    <!-- Main content -->
    <div id="modal-main">
      <div class="modal-plane-preview">
        <img id="modal-img" src="" alt="">
      </div>
      <div class="modal-plan-name" id="modal-plan-name" style="color:var(--teal)">‚Äî</div>
      <div class="modal-plane-type" id="modal-plane-type">‚Äî</div>

      <div class="modal-recap">
        <div class="recap-row">
          <div class="recap-lbl">Co√ªt d'investissement</div>
          <div class="recap-val" id="m-cost" style="color:var(--orange)">‚Äî</div>
        </div>
        <div class="recap-row">
          <div class="recap-lbl">Gain quotidien</div>
          <div class="recap-val" id="m-daily" style="color:var(--teal)">‚Äî</div>
        </div>
        <div class="recap-row">
          <div class="recap-lbl">Dur√©e</div>
          <div class="recap-val" id="m-dur" style="color:var(--text2)">‚Äî</div>
        </div>
        <div class="recap-row">
          <div class="recap-lbl">Gain total estim√©</div>
          <div class="recap-val" id="m-total" style="color:var(--gold)">‚Äî</div>
        </div>
        <div class="recap-row">
          <div class="recap-lbl">Votre solde actuel</div>
          <div class="recap-val" id="m-balance" style="color:var(--text)">‚Äî</div>
        </div>
      </div>

      <div class="modal-warning">
        <span class="wi">‚ö†Ô∏è</span>
        <span>Le montant sera <strong>imm√©diatement d√©duit</strong> de votre solde. Les gains sont cr√©dit√©s chaque jour automatiquement.</span>
      </div>

      <div id="modal-err" style="display:none;background:rgba(255,59,78,.1);border:1px solid rgba(255,59,78,.3);border-radius:12px;padding:12px 14px;margin-bottom:14px;font-size:13px;color:#FF6B7A;"></div>

      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal()">Annuler</button>
        <button class="btn-confirm" id="btn-confirm" onclick="confirmInvest()">
          üöÄ Investir Maintenant
        </button>
      </div>
    </div>

    <!-- Success state -->
    <div class="modal-success" id="modal-success">
      <div class="ms-ico">‚úàÔ∏è</div>
      <div class="ms-title" id="ms-title">Investissement Activ√© !</div>
      <div class="ms-msg" id="ms-msg">Vos gains d√©butent d√®s maintenant. Consultez votre tableau de bord.</div>
      <button class="ms-btn" onclick="window.location.href='dashboard.html'">Voir le Dashboard ‚Üí</button>
    </div>
  </div>
</div>

<!-- PAGE -->
<div class="page">

  <!-- TOPBAR -->
  <div class="topbar">
    <a href="dashboard.html" class="back-btn">‚Üê Retour</a>
    <div class="page-title">MES PLANS</div>
    <div class="balance-pill">üí∞ <span id="bal-display">‚Ä¶</span> F</div>
  </div>

  <!-- HERO -->
  <div class="hero-sec">
    <h1>CHOISISSEZ<br>VOTRE VOL</h1>
    <p>Plus haut vous volez, plus vos rendements d√©collent. S√©lectionnez votre plan d'investissement.</p>
  </div>

  <!-- PLANS -->
  <div class="plans-list" id="plans-container"></div>

</div>

<!-- BOTTOM NAV -->
<nav class="bot-nav">
  <a href="dashboard.html" class="nav-item"><span class="nav-ico">üè†</span><span class="nav-lbl">Accueil</span></a>
  <a href="plan.html" class="nav-item active"><span class="nav-ico">üöÄ</span><span class="nav-lbl">Plans</span></a>
  <a href="retrait.html" class="nav-item"><span class="nav-ico">üí∏</span><span class="nav-lbl">Retrait</span></a>
  <a href="profil.html" class="nav-item"><span class="nav-ico">üë§</span><span class="nav-lbl">Profil</span></a>
</nav>

<script>
/* ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ */
const{createClient}=supabase;
const sb=createClient(
  'https://fqiotqrraobmsrcyewsi.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxaW90cXJyYW9ibXNyY3lld3NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjA3NzUsImV4cCI6MjA4NzM5Njc3NX0.pmvaQikEDEj705o7kBBWwkLwAoZ62D-GoxjFm5HEHNc'
);

/* ‚îÄ‚îÄ PLANS DATA ‚îÄ‚îÄ */
const PLANS = [
  {
    id: 1,
    name: "PLAN STARTER",
    plane: "Cessna 172",
    planeDesc: "Monomoteur l√©ger ¬∑ Id√©al pour d√©buter",
    img: "https://images.unsplash.com/photo-1570710891163-6d3b5c47248b?w=800&q=80",
    cost: 2000,
    daily: 400,
    days: 30,
    tier: "STARTER",
    color: "#38BDF8",
    shadow: "rgba(56,189,248,.2)",
    border: "rgba(56,189,248,.3)",
    gradFrom: "#38BDF8",
    gradTo: "#0EA5E9",
    badgeBg: "linear-gradient(135deg,#0EA5E9,#38BDF8)",
    roiPct: 20,
    features: ["Retrait apr√®s 30j", "Gains quotidiens", "Support 24/7"],
  },
  {
    id: 2,
    name: "PLAN EXPLORER",
    plane: "Boeing 737",
    planeDesc: "Moyen-courrier ¬∑ Croissance r√©guli√®re",
    img: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800&q=80",
    cost: 5000,
    daily: 800,
    days: 30,
    tier: "EXPLORER",
    color: "#00C9C0",
    shadow: "rgba(0,201,192,.2)",
    border: "rgba(0,201,192,.3)",
    gradFrom: "#00C9C0",
    gradTo: "#00EDDE",
    badgeBg: "linear-gradient(135deg,#008E89,#00C9C0)",
    roiPct: 38,
    features: ["Rendement x2", "Priorit√© support", "Acc√®s coffre"],
  },
  {
    id: 3,
    name: "PLAN PREMIUM",
    plane: "Airbus A320",
    planeDesc: "Long-courrier ¬∑ Hautes performances",
    img: "https://images.unsplash.com/photo-1556388158-158ea5ccacbd?w=800&q=80",
    cost: 15000,
    daily: 1500,
    days: 30,
    tier: "PREMIUM",
    color: "#A064FF",
    shadow: "rgba(160,100,255,.2)",
    border: "rgba(160,100,255,.3)",
    gradFrom: "#A064FF",
    gradTo: "#7C3AED",
    badgeBg: "linear-gradient(135deg,#7C3AED,#A064FF)",
    roiPct: 60,
    features: ["Rendement premium", "Gestionnaire d√©di√©", "Rapport hebdo"],
  },
  {
    id: 4,
    name: "PLAN ELITE",
    plane: "Boeing 777",
    planeDesc: "Grand porteur ¬∑ Rendements √©lev√©s",
    img: "https://images.unsplash.com/photo-1544636331-e26879cd4d9b?w=800&q=80",
    cost: 25000,
    daily: 2500,
    days: 30,
    tier: "ELITE ‚òÖ",
    color: "#FF7A35",
    shadow: "rgba(255,122,53,.2)",
    border: "rgba(255,122,53,.35)",
    gradFrom: "#FF7A35",
    gradTo: "#FFB830",
    badgeBg: "linear-gradient(135deg,#E55A1C,#FF7A35)",
    roiPct: 80,
    features: ["ROI optimis√©", "Retraits acc√©l√©r√©s", "VIP access"],
  },
  {
    id: 5,
    name: "PLAN DIAMANT",
    plane: "Airbus A380",
    planeDesc: "Le g√©ant des airs ¬∑ Rendements maximaux",
    img: "https://images.unsplash.com/photo-1609349093896-8f9b6b0c5b9c?w=800&q=80",
    cost: 50000,
    daily: 5000,
    days: 30,
    tier: "üíé DIAMANT",
    color: "#F5C842",
    shadow: "rgba(245,200,66,.25)",
    border: "rgba(245,200,66,.4)",
    gradFrom: "#F5C842",
    gradTo: "#FFD700",
    badgeBg: "linear-gradient(135deg,#B8960C,#F5C842)",
    roiPct: 100,
    features: ["Rendement MAXIMUM", "Conseiller priv√©", "Club exclusif"],
  },
];

/* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
let currentUser = null;
let userBalance = 0;
let activeInvestments = [];
let selectedPlan = null;

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
async function init() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'index.html'; return; }
  currentUser = session.user;
  await loadBalance();
  await loadActiveInvestments();
  renderPlans();
  document.getElementById('loader').classList.add('hide');
  // Credit daily gains (simulate)
  await creditPendingGains();
}

/* ‚îÄ‚îÄ LOAD BALANCE ‚îÄ‚îÄ */
async function loadBalance() {
  try {
    const{data,error}=await sb.rpc('get_solde',{p_user_id:currentUser.id});
    userBalance=error?0:Math.max(0,Number(data)||0);
  } catch(e) { userBalance=0; }
  document.getElementById('bal-display').textContent = fmt(userBalance);
  document.getElementById('m-balance').textContent = fmt(userBalance) + ' FCFA';
}

/* ‚îÄ‚îÄ LOAD ACTIVE INVESTMENTS ‚îÄ‚îÄ */
async function loadActiveInvestments() {
  try {
    const { data } = await sb.from('investments')
      .select('*').eq('user_id', currentUser.id).eq('status', 'active');
    if (data) activeInvestments = data;
  } catch(e) { activeInvestments = []; }
}

/* ‚îÄ‚îÄ CREDIT PENDING DAILY GAINS ‚îÄ‚îÄ */
async function creditPendingGains() {
  if (!activeInvestments.length) return;
  const now = new Date();
  for (const inv of activeInvestments) {
    try {
      const start = new Date(inv.start_date);
      const lastCredit = inv.last_credit_date ? new Date(inv.last_credit_date) : start;
      const daysSinceCredit = Math.floor((now - lastCredit) / (1000 * 60 * 60 * 24));
      const daysTotal = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      const daysLeft = inv.duration_days - daysTotal;

      if (daysSinceCredit >= 1 && daysLeft > 0) {
        const daysToCredit = Math.min(daysSinceCredit, daysLeft);
        const gainAmount = inv.daily_gain * daysToCredit;

        await sb.from('transactions').insert({
          user_id: currentUser.id,
          type: 'gain',
          label: `Gain quotidien ‚Äî ${inv.plan_name} (${daysToCredit}j)`,
          amount: gainAmount,
          status: 'credited',
          created_at: new Date().toISOString()
        });

        await sb.from('investments').update({
          last_credit_date: now.toISOString(),
          days_credited: (inv.days_credited || 0) + daysToCredit
        }).eq('id', inv.id);

        // Close investment if finished
        if (daysTotal >= inv.duration_days) {
          await sb.from('investments').update({ status: 'completed' }).eq('id', inv.id);
        }
      }
    } catch(e) {}
  }
}

/* ‚îÄ‚îÄ RENDER PLANS ‚îÄ‚îÄ */
function renderPlans() {
  const container = document.getElementById('plans-container');
  const activeIds = activeInvestments.map(i => i.plan_id);

  container.innerHTML = PLANS.map(p => {
    const isActive = activeIds.includes(p.id);
    const totalGain = p.daily * p.days;
    const roiPct = Math.round((totalGain / p.cost) * 100);

    return `
    <div class="plan-card" style="--pb:${p.border};--ps:${p.shadow};">
      <div class="plane-img-wrap">
        <img class="plane-img" src="${p.img}" alt="${p.plane}" loading="lazy"
          onerror="this.src='https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800&q=80'">
        <div class="plan-badge-wrap">
          <div class="plan-badge" style="background:${p.badgeBg}">PLAN ${p.id}</div>
          <div class="tier-badge" style="color:${p.color};border-color:${p.border}">${p.tier}</div>
        </div>
      </div>
      <div class="plan-body">
        <div class="plan-name" style="color:${p.color}">${p.name}</div>
        <div class="plan-plane-name">‚úàÔ∏è ${p.plane} ¬∑ ${p.planeDesc}</div>
        <div class="plan-stats">
          <div class="ps-item">
            <div class="ps-val" style="color:${p.color}">${fmt(p.cost)}</div>
            <div class="ps-lbl">Mise (F)</div>
          </div>
          <div class="ps-item">
            <div class="ps-val" style="color:var(--teal-l)">${fmt(p.daily)}</div>
            <div class="ps-lbl">/ Jour (F)</div>
          </div>
          <div class="ps-item">
            <div class="ps-val" style="color:var(--gold)">${fmt(totalGain)}</div>
            <div class="ps-lbl">Total (F)</div>
          </div>
        </div>
        <div class="roi-row">
          <div class="roi-label">ROI</div>
          <div class="roi-bar"><div class="roi-fill" style="width:${Math.min(p.roiPct,100)}%;background:linear-gradient(90deg,${p.gradFrom},${p.gradTo})"></div></div>
          <div class="roi-pct" style="color:${p.color}">+${roiPct}%</div>
        </div>
        <div class="plan-features">
          ${p.features.map(f=>`<div class="feat">‚úì ${f}</div>`).join('')}
          <div class="feat">üìÖ ${p.days} jours</div>
        </div>
        ${isActive
          ? `<button class="invest-btn active-plan"><span class="checkmark">‚úÖ</span> Plan Actif ‚Äî En cours</button>`
          : `<button class="invest-btn" style="background:linear-gradient(135deg,${p.gradFrom},${p.gradTo});box-shadow:0 8px 28px ${p.shadow};"
              onclick="openModal(${p.id})">üöÄ Investir ${fmt(p.cost)} FCFA</button>`
        }
      </div>
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
function openModal(planId) {
  selectedPlan = PLANS.find(p => p.id === planId);
  if (!selectedPlan) return;

  const p = selectedPlan;
  const totalGain = p.daily * p.days;

  document.getElementById('modal-img').src = p.img;
  document.getElementById('modal-plan-name').textContent = p.name;
  document.getElementById('modal-plan-name').style.color = p.color;
  document.getElementById('modal-plane-type').textContent = `‚úàÔ∏è ${p.plane} ¬∑ ${p.planeDesc}`;
  document.getElementById('m-cost').textContent = fmt(p.cost) + ' FCFA';
  document.getElementById('m-daily').textContent = '+' + fmt(p.daily) + ' FCFA / jour';
  document.getElementById('m-dur').textContent = p.days + ' jours';
  document.getElementById('m-total').textContent = '+' + fmt(totalGain) + ' FCFA';
  document.getElementById('m-balance').textContent = fmt(userBalance) + ' FCFA';
  document.getElementById('modal-err').style.display = 'none';
  document.getElementById('modal-main').style.display = 'block';
  document.getElementById('modal-success').classList.remove('show');

  const btn = document.getElementById('btn-confirm');
  btn.style.background = `linear-gradient(135deg,${p.gradFrom},${p.gradTo})`;
  btn.style.boxShadow = `0 8px 24px ${p.shadow}`;
  btn.disabled = false;
  btn.innerHTML = 'üöÄ Investir Maintenant';

  document.getElementById('modal-overlay').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal(e) {
  if (e && e.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('show');
  document.body.style.overflow = '';
  selectedPlan = null;
}

/* ‚îÄ‚îÄ CONFIRM INVEST ‚îÄ‚îÄ */
async function confirmInvest() {
  if (!selectedPlan || !currentUser) return;
  const p = selectedPlan;
  const errEl = document.getElementById('modal-err');
  errEl.style.display = 'none';

  // Check balance
  if (userBalance < p.cost) {
    errEl.style.display = 'block';
    errEl.textContent = `‚ùå Solde insuffisant. Vous avez ${fmt(userBalance)} FCFA, il vous faut ${fmt(p.cost)} FCFA.`;
    return;
  }

  const btn = document.getElementById('btn-confirm');
  btn.disabled = true;
  btn.innerHTML = '<span class="ld"></span>Traitement‚Ä¶';

  try {
    const now = new Date().toISOString();

    // 0. V√©rifier le solde en temps r√©el avant tout
    const{data:soldeCheck}=await sb.rpc('get_solde',{p_user_id:currentUser.id});
    const soldeReel=Number(soldeCheck)||0;
    if(soldeReel<p.cost){
      throw new Error(`Solde insuffisant. Disponible: ${fmt(soldeReel)} FCFA, requis: ${fmt(p.cost)} FCFA`);
    }

    // 1. Create investment transaction (debit)
    const { error: txErr } = await sb.from('transactions').insert({
      user_id: currentUser.id,
      type: 'investissement',
      label: `Investissement ${p.name} ‚Äî ${p.plane}`,
      amount: p.cost,
      status: 'credited',
      created_at: now
    });
    if (txErr) throw txErr;

    // 2. Create investment record
    const { error: invErr } = await sb.from('investments').insert({
      user_id: currentUser.id,
      plan_id: p.id,
      plan_name: p.name,
      plane_name: p.plane,
      amount: p.cost,
      daily_gain: p.daily,
      duration_days: p.days,
      days_credited: 0,
      status: 'active',
      start_date: now,
      last_credit_date: now,
      created_at: now
    });
    if (invErr) throw invErr;

    // 3. Commission parrainage (10% au parrain si filleul)
    // Appel silencieux ‚Äî ne bloque pas m√™me en cas d'erreur
    sb.rpc('commission_parrainage', {
      p_filleul_id : currentUser.id,
      p_montant    : p.cost,
      p_plan_name  : p.name
    }).then(r => {
      if(r.data?.commission) console.log('[COMMISSION]', r.data.msg);
    }).catch(() => {});

    // 4. Show success
    document.getElementById('modal-main').style.display = 'none';
    const ms = document.getElementById('modal-success');
    ms.classList.add('show');
    document.getElementById('ms-title').textContent = `${p.name} Activ√© ! ‚úàÔ∏è`;
    document.getElementById('ms-msg').textContent = `Votre ${p.plane} est en vol ! Vous recevrez +${fmt(p.daily)} FCFA chaque jour pendant ${p.days} jours.`;

    // Update local balance
    userBalance -= p.cost;
    document.getElementById('bal-display').textContent = fmt(userBalance);

    // Refresh active investments
    await loadActiveInvestments();
    renderPlans();

  } catch(err) {
    btn.disabled = false;
    btn.innerHTML = 'üöÄ Investir Maintenant';
    errEl.style.display = 'block';
    errEl.textContent = '‚ùå Erreur : ' + (err.message || 'Une erreur est survenue. R√©essayez.');
  }
}

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
function fmt(n) { return Number(n).toLocaleString('fr-FR'); }

/* ‚îÄ‚îÄ START ‚îÄ‚îÄ */
init();
</script>
</body>
</html>
